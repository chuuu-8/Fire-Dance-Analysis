<!DOCTYPE html>
<html>
<head>
    <title>火舞分析系統</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>火舞分析系統</h1>

    <div id="loading">
        <div class="spinner"></div>
        <p style="font-size: 1.2rem; font-weight: bold;">正在解析動作...</p>
        <p style="color: #888; margin-top: 10px;">請稍候，影片越長處理時間越久</p>
    </div>

    <form action="/analyze" method="post" enctype="multipart/form-data" onsubmit="document.getElementById('loading').style.display='flex'">

        <label>YouTube 連結</label>
        <input type="text" id="youtube_url" name="youtube_url" placeholder="貼上網址..." onchange="checkDuration()">

        <div style="text-align: center; margin: 20px 0; color: #555; font-size: 0.9rem;">或</div>

        <label>上傳影片檔案</label>
        <input type="file" name="file" accept="video/*">

        <label>畫質設定</label>
        <select name="quality">
            <option value="best">自動最佳畫質</option>
            <option value="720p">720p (推薦)</option>
            <option value="480p">480p (快速)</option>
        </select>

        <label>分析模式</label>
        <select name="analysis_mode">
            <option value="balanced">平衡模式 (推薦)</option>
            <option value="fast">快速模式</option>
            <option value="accurate">精確模式</option>
        </select>

        <label>裁剪片段 (秒)</label>
        <div id="rangeContainer">
            <span class="time-label" id="startLabel">0s</span>
            <input type="range" id="startRange" name="start" min="0" max="100" value="0">
            <input type="range" id="endRange" name="end" min="0" max="100" value="0">
            <span class="time-label" id="endLabel">自動</span>
        </div>

        <button type="submit">開始分析</button>
    </form>

    <script>
        const startRange = document.getElementById('startRange');
        const endRange = document.getElementById('endRange');
        const startLabel = document.getElementById('startLabel');
        const endLabel = document.getElementById('endLabel');
        const youtubeInput = document.getElementById('youtube_url');

        let maxDuration = 100;

        function updateSliderMax(duration) {
            maxDuration = duration;
            startRange.max = duration;
            endRange.max = duration;
            if (endRange.value == 0 || endRange.value == 100) {
                endRange.value = duration;
                endLabel.textContent = duration + "s";
            }
        }

        async function checkDuration() {
            const url = youtubeInput.value;
            if (!url) return;
            endLabel.textContent = "...";
            try {
                const formData = new FormData();
                formData.append('youtube_url', url);
                const response = await fetch('/api/video_duration', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.duration) updateSliderMax(data.duration);
            } catch (e) {
                endLabel.textContent = "自動";
            }
        }

        startRange.addEventListener('input', () => {
            let startSec = parseInt(startRange.value);
            let endSec = parseInt(endRange.value);
            if (startSec > endSec) { startRange.value = endSec; startSec = endSec; }
            startLabel.textContent = startSec + "s";
        });

        endRange.addEventListener('input', () => {
            let startSec = parseInt(startRange.value);
            let endSec = parseInt(endRange.value);
            if (endSec < startSec) { endRange.value = startSec; endSec = startSec; }
            endLabel.textContent = endSec + "s";
        });
    </script>
</body>
</html>
