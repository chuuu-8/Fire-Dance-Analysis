<!DOCTYPE html>
<html>
<head>
    <title>分析結果</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="result-container">
    <h2>分析報告</h2>

    <div class="video-section">
        <video id="videoPlayer" controls playsinline>
            <source src="{{ url_for('processed_file', filename=output_video) }}" type="video/mp4">
            <source src="{{ url_for('processed_file', filename=output_video.replace('.mp4', '.avi')) }}" type="video/avi">
            瀏覽器不支援播放
        </video>
        <div id="moveDisplay" class="move-display">
            <div style="font-size: 1.2rem; font-weight: bold;">準備播放...</div>
        </div>
    </div>

    <div class="stats-section">
        <div class="stat-card">
            <h3>總時長</h3>
            <p>{{ "%.1f"|format(total_frames/30) }}s</p>
        </div>
        <div class="stat-card">
            <h3>識別率</h3>
            <p>{{ "%.1f"|format(analyzed_frames / total_frames * 100) }}%</p>
        </div>
        {% if merged_timeline %}
        <div class="stat-card">
            <h3>招式數</h3>
            <p>{{ merged_timeline|length }}</p>
        </div>
        <div class="stat-card">
            <h3>最常出現</h3>
            <p>
                {% set ns = namespace(max=0, move='無') %}
                {% for k, v in move_stats.items() %}
                    {% if v > ns.max %}{% set ns.max = v %}{% set ns.move = k %}{% endif %}
                {% endfor %}
                {{ ns.move }}
            </p>
        </div>
        {% endif %}
    </div>

    {% if merged_timeline %}
    <h3>招式時間軸</h3>
    <div class="segments-container">
        {% for segment in merged_timeline %}
        <div class="segment-row" onclick="jumpToTime({{ segment.start }})">
            <div style="display:flex; align-items:center;">
                <span class="segment-time">{{ "%.1f"|format(segment.start) }}s</span>
                <span class="segment-move">{{ segment.move_zh }}</span>
            </div>
            <div class="segment-confidence {% if segment.confidence > 0.8 %}conf-high{% elif segment.confidence > 0.5 %}conf-medium{% else %}conf-low{% endif %}">
                {{ (segment.confidence * 100)|int }}%
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
        <p>未偵測到明確招式</p>
    </div>
    {% endif %}

    <div style="text-align: center;">
        <a href="{{ url_for('index') }}" class="back-button">回首頁</a>
    </div>
</div>

<script>
    const moves = {{ move_timeline|tojson }};
    const video = document.getElementById('videoPlayer');
    const moveDisplay = document.getElementById('moveDisplay');

    video.ontimeupdate = function() {
        let currentTime = video.currentTime;
        let currentMove = null;
        for (let i = moves.length - 1; i >= 0; i--) {
            if (moves[i].time <= currentTime) {
                if (currentTime - moves[i].time < 1.5) currentMove = moves[i];
                break;
            }
        }

        if (currentMove) {
            const conf = (currentMove.confidence * 100).toFixed(0);
            let color = "#ff4b1f";
            if(currentMove.confidence > 0.8) color = "#4ade80";
            else if(currentMove.confidence > 0.5) color = "#facc15";

            moveDisplay.innerHTML = `
                <div style="font-size: 1.5rem; font-weight: bold; color: #fff;">${currentMove.move_zh}</div>
                <div style="font-size: 0.9rem; color: #ccc; margin-top: 5px;">
                    信心度：<span style="color:${color}">${conf}%</span>
                </div>
            `;
        } else {
            moveDisplay.innerHTML = `<div style="color:#666">...</div>`;
        }
    };

    function jumpToTime(time) {
        video.currentTime = time;
        video.play();
    }
</script>
</body>
</html>
